---
title: createStateMachine
type: api
order: 1
---

`createStateMachine :: FSM_Def -> FSM`

## Description
This FSM factory function takes the parameters defining the behavior of the state transducer and returns the created state machine. The created state machine is a regular function called with inputs that are passed to the encapsulated state machine, which computes the function's output. The syntax for an input is `{[eventLabel] : eventData}`, i.e. an input is an object with exactly one key, which is the event identifier, and the value matching the key is the event data.

The machine additionally may carry over environment variables, which are accessible in guards, and action factories. This helps to maintain such functions pure and testable. Environment variables can also be used to parameterize the state machine's behavior.

History pseudo-states are generated by a helper function `historyState :: HistoryType -> ControlState -> HistoryPseudoState`. A history state is coupled to a compound control state and has a type (deep or shallow). Passing this information to the factory produces the sought history state. 

The `settings.updateState` property is mandatory and specifies how to update a model from the `.updates` produced by an action factory. We used successfully [JSON patch](http://jsonpatch.com/) operations for model updates, but you can choose to use the immutable library of your choice or a simple reducer. The important point is that the extended state should not be modified in place, i.e. `updateState` is a pure function. 

The `settings.debug.checkContracts`, when set, represents contracts that the state machine must fulfill. The `kingly` library comes by default with a set of contracts enforcing most of the syntax and semantics of the state machine format chosen.

The `settings.debug.console`, when set, represents a `console` object through which tracing and debug info will flow. This is useful in development and can be turned off in production.

## Contracts
- All [previously mentioned](https://github.com/brucou/kingly#contracts) contracts apply.
- [Type contracts](https://github.com/brucou/kingly/blob/master/src/types.js)
- The `settings.updateState` property is mandatory!
- The `settings` property **should not be modified** after being passed as parameter (i.e. should be a constant): it is not cloned and is passed to all relevant functions (guards, etc.)

## Implementation example
We are going to show the definition for the following hierarchical state machine:

{% fig %}
![deep and shallow history](../../api-assets/history%20transitions,%20INIT%20event%20CASCADING%20transitions.png)
{% endfig %}

The definition is as follows:

```javascript
const states = { [OUTER]: { [INNER]: { [INNER_S]: '', [INNER_T]: '' }, [OUTER_A]: '', [OUTER_B]: '' }, [Z]: '' };
  const fsmDef = {
    states,
    events: [EVENT1, EVENT2, EVENT3, EVENT4],
    initialExtendedState: { history: SHALLOW, counter: 0 },
    transitions: [
      { from: INIT_STATE, event: INIT_EVENT, to: OUTER, action: ACTION_IDENTITY },
      { from: OUTER, event: INIT_EVENT, to: OUTER_A, action: ACTION_IDENTITY },
      { from: OUTER_A, event: EVENT1, to: INNER, action: ACTION_IDENTITY },
      { from: INNER, event: INIT_EVENT, to: INNER_S, action: ACTION_IDENTITY },
      { from: INNER_S, event: EVENT3, to: INNER_T, action: ACTION_IDENTITY },
      { from: INNER_T, event: EVENT3, to: INNER_S, action: ACTION_IDENTITY },
      { from: INNER, event: EVENT2, to: OUTER_B, action: ACTION_IDENTITY },
      { from: OUTER, event: EVENT1, to: Z, action: ACTION_IDENTITY },
      {
        from: Z, event: EVENT4, guards: [
          {
            predicate: function isDeep(x, e) {return x.history === DEEP},
            to: historyState(DEEP, OUTER),
            action: incCounter
          },
          {
            predicate: function isShallow(x, e) {return x.history !== DEEP},
            to: historyState(SHALLOW, OUTER),
            action: incCounter
          }
        ]
      },
    ],
    settings : { updateState : applyJSONpatch }
  };
```

Note in particular:
- the nesting of states in `states`
- the use of `ACTION_IDENTITY` when there is no action to be applied
  - that action does not modify the extended state of the machine, and returns `NO_OUTPUT`
- how history states are included in the machine definition with `historyState`

There are plenty of additional examples in the [test directory](https://github.com/brucou/kingly/blob/master/test/hierarchy.specs.js).
